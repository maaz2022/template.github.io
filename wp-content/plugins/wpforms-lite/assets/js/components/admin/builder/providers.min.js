var WPForms=window.WPForms||{};WPForms.Admin=WPForms.Admin||{},WPForms.Admin.Builder=WPForms.Admin.Builder||{},WPForms.Admin.Builder.Providers=WPForms.Admin.Builder.Providers||function(e,l){"use strict";var f={cache:{},config:{templates:["wpforms-providers-builder-content-connection-fields","wpforms-providers-builder-content-connection-conditionals"]},fields:{}},p={panelHolder:{},form:l("#wpforms-builder-form"),spinner:'<i class="wpforms-loading-spinner wpforms-loading-inline"></i>',ajax:{_mergeData:function(e,n){e={id:p.form.data("id"),revision_id:p.form.data("revision"),nonce:wpforms_builder.nonce,action:"wpforms_builder_provider_ajax_"+e};return l.extend(e,n),e},request:function(o,e){var i=p.getProviderHolder(o),t=i.find(".wpforms-builder-provider-connections-save-lock"),d=i.find(".wpforms-builder-provider-connections-error"),n={url:wpforms_builder.ajax_url,type:"post",dataType:"json",beforeSend:function(){i.addClass("loading"),t.val(1),d.hide()}};return e.data=p.ajax._mergeData(o,e.data||{}),l.extend(n,e),l.ajax(n).fail(function(e,n,r){console.error("provider:",o),console.error(e),console.error(n),t.val(1),d.show()}).always(function(e,n,r){i.removeClass("loading"),"success"===n&&t.val(0)})}},cache:{get:function(e,n){return void 0!==f.cache[e]&&f.cache[e]instanceof Map?f.cache[e].get(n):null},getById:function(e,n,r){return void 0===this.get(e,n)[r]?null:this.get(e,n)[r]},set:function(e,n,r){return void 0!==f.cache[e]&&f.cache[e]instanceof Map||(f.cache[e]=new Map),f.cache[e].set(n,r)},addTo:function(e,n,r,o){void 0!==f.cache[e]&&f.cache[e]instanceof Map||(f.cache[e]=new Map,this.set(e,n,{}));var i=this.get(e,n);return i[r]=o,this.set(e,n,i)},delete:function(e,n){return void 0!==f.cache[e]&&f.cache[e]instanceof Map?f.cache[e].delete(n):null},deleteFrom:function(e,n,r){if(void 0===f.cache[e]||!(f.cache[e]instanceof Map))return null;var o=this.get(e,n);return delete o[r],this.set(e,n,o)},clear:function(e){void 0!==f.cache[e]&&f.cache[e]instanceof Map&&f.cache[e].clear()}},init:function(){l(p.ready)},ready:function(){f.fields=l.extend({},wpf.getFields(!1,!0)),p.panelHolder=l("#wpforms-panel-providers, #wpforms-panel-settings"),p.Templates=WPForms.Admin.Builder.Templates,p.Templates.add(f.config.templates),p.bindActions(),p.ui.bindActions(),p.panelHolder.trigger("WPForms.Admin.Builder.Providers.ready")},bindActions:function(){l(e).on("wpformsSaved",function(){var o,e=p.panelHolder.find(".wpforms-builder-provider-connection");e.length&&(o=!1,e.each(function(){var e,n,r=!1;l(this).find("input.wpforms-required, select.wpforms-required, textarea.wpforms-required").each(function(){var e=l(this).val();_.isEmpty(e)?(l(this).addClass("wpforms-error"),r=!0):l(this).removeClass("wpforms-error")}),r&&!o&&((e=l(this).closest(".wpforms-builder-provider").find(".wpforms-builder-provider-title").clone()).find("button").remove(),n=wpforms_builder.provider_required_flds,l.alert({title:wpforms_builder.heads_up,content:n.replace("{provider}","<strong>"+e.text().trim()+"</strong>"),icon:"fa fa-exclamation-circle",type:"orange",buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"]}}}),o=!0)}),"fields"===wpf.getQueryString("view")&&p.updateMapSelects(e))}),p.panelHolder.on("connectionRendered",function(){!0===wpf.initialSave&&(wpf.savedState=wpf.getFormState("#wpforms-builder-form"))})},updateMapSelects:function(e){var n=l.extend({},wpf.getFields()),r=_.mapObject(n,function(e,n){return e.label}),o=_.mapObject(f.fields,function(e,n){return e.label});if(!(_.isEmpty(r)&&_.isEmpty(o)||JSON.stringify(r)===JSON.stringify(o))){for(var i,t,d,c=Object.keys(r).map(function(e){return parseInt(e,10)}),a=Object.keys(o).map(function(e){return parseInt(e,10)}).filter(function(e){return!c.includes(e)}),s=0;s<a.length;s++)l('.wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-field-value option[value="'+a[s]+'"]',e).remove();for(d in n)i=void 0!==n[d].label&&""!==n[d].label.toString().trim()?wpf.sanitizeHTML(n[d].label.toString().trim()):wpforms_builder.field+" #"+d,(t=l('.wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-field-value option[value="'+d+'"]',e)).length?wpf.sanitizeHTML(n[d].label)!==wpf.sanitizeHTML(o[d])&&t.text(i):l(".wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-field-value",e).append(l("<option>",{value:d,text:i}));wpf.savedState!==wpf.getFormState("#wpforms-builder-form")&&(wpf.savedState=wpf.getFormState("#wpforms-builder-form")),f.fields=n,p.panelHolder.trigger("WPForms.Admin.Builder.Providers.updatedMapSelects",[e,n])}},ui:{bindActions:function(){p.panelHolder.on("click",".js-wpforms-builder-provider-account-add",function(e){e.preventDefault(),p.ui.account.setProvider(l(this).data("provider")),p.ui.account.add()}).on("click",".js-wpforms-builder-provider-connection-add",function(e){e.preventDefault(),p.ui.connectionAdd(l(this).data("provider"))}).on("click",".js-wpforms-builder-provider-connection-delete",function(e){var n=l(this);e.preventDefault(),p.ui.connectionDelete(n.closest(".wpforms-builder-provider").data("provider"),n.closest(".wpforms-builder-provider-connection"))}),p.panelHolder.on("click",".js-wpforms-builder-provider-connection-fields-add",function(e){e.preventDefault();var e=l(this).parents(".wpforms-builder-provider-connection-fields-table"),n=e.find("tr").last().clone(!0),r=parseInt(/\[.+]\[.+]\[.+]\[(\d+)]/.exec(n.find(".wpforms-builder-provider-connection-field-name").attr("name"))[1],10)+1;n.find(".wpforms-builder-provider-connection-field-name").attr("name",n.find(".wpforms-builder-provider-connection-field-name").attr("name").replace(/\[fields_meta\]\[(\d+)\]/g,"[fields_meta]["+r+"]")).val(""),n.find(".wpforms-builder-provider-connection-field-value").attr("name",n.find(".wpforms-builder-provider-connection-field-value").attr("name").replace(/\[fields_meta\]\[(\d+)\]/g,"[fields_meta]["+r+"]")).val(""),n.find(".js-wpforms-builder-provider-connection-fields-delete").removeClass("hidden"),e.find("tbody").append(n.get(0))}).on("click",".js-wpforms-builder-provider-connection-fields-delete",function(e){e.preventDefault(),l(this).parents(".wpforms-builder-provider-connection-fields-table tr").remove()}),p.panelHolder.on("connectionGenerated",function(e,n){wpf.initTooltips(),l(this).find('.wpforms-builder-provider-connection[data-connection_id="'+n.connection.id+'"]').closest(".wpforms-panel-content-section").find(".wpforms-builder-provider-connections-default").addClass("wpforms-hidden")}),p.panelHolder.on("connectionRendered",function(e,n,r){if(wpf.initTooltips(),void 0===r){if(!_.isObject(n)||!_.has(n,"connection_id"))return;r=n.connection_id}l(this).find('.wpforms-builder-provider-connection[data-connection_id="'+r+'"] .wpforms-field-map-select').length&&wpf.fieldUpdate()})},connectionAdd:function(r){l.confirm({title:!1,content:wpforms_builder_providers.prompt_connection.replace(/%type%/g,"connection")+'<input autofocus="" type="text" id="wpforms-builder-provider-connection-name" placeholder="'+wpforms_builder_providers.prompt_placeholder+'"><p class="error">'+wpforms_builder_providers.error_name+"</p>",icon:"fa fa-info-circle",type:"blue",buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"],action:function(){var e=this.$content.find("#wpforms-builder-provider-connection-name").val().trim(),n=this.$content.find(".error");if(""===e)return n.show(),!1;p.getProviderHolder(r).trigger("connectionCreate",[e])}},cancel:{text:wpforms_builder.cancel}}})},connectionDelete:function(n,r){l.confirm({title:!1,content:wpforms_builder_providers.confirm_connection,icon:"fa fa-exclamation-circle",type:"orange",buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"],action:function(){p.getProviderHolder(n).trigger("connectionDelete",[r]);var e=r.closest(".wpforms-panel-content-section");r.fadeOut("fast",function(){l(this).remove(),p.getProviderHolder(n).trigger("connectionDeleted",[r]),e.find(".wpforms-builder-provider-connection").length||e.find(".wpforms-builder-provider-connections-default").removeClass("wpforms-hidden")})}},cancel:{text:wpforms_builder.cancel}}})},account:{provider:"",submitHandlers:[],setProvider:function(e){this.provider=e},add:function(){var o=this;l.confirm({title:!1,smoothContent:!0,content:function(){var n=this;return p.ajax.request(o.provider,{data:{task:"account_template_get"}}).done(function(e){e.success&&(e.data.title.length&&n.setTitle(e.data.title),e.data.content.length&&n.setContent(e.data.content),e.data.type.length&&n.setType(e.data.type),p.getProviderHolder(o.provider).trigger("accountAddModal.content.done",[n,o.provider,e]))}).fail(function(){p.getProviderHolder(o.provider).trigger("accountAddModal.content.fail",[n,o.provider])}).always(function(){p.getProviderHolder(o.provider).trigger("accountAddModal.content.always",[n,o.provider])})},contentLoaded:function(e,n,r){this.buttons.add.enable(),this.buttons.cancel.enable(),p.getProviderHolder(o.provider).trigger("accountAddModal.contentLoaded",[this])},onOpenBefore:function(){this.buttons.add.disable(),this.buttons.cancel.disable(),this.$body.addClass("wpforms-providers-account-add-modal"),p.getProviderHolder(o.provider).trigger("accountAddModal.onOpenBefore",[this])},onClose:function(){!0===p.ui.account.isConfigured(o.provider)&&p.ui.connectionAdd(o.provider)},icon:"fa fa-info-circle",type:"blue",buttons:{add:{text:wpforms_builder.provider_add_new_acc_btn,btnClass:"btn-confirm",keys:["enter"],action:function(){if(p.getProviderHolder(o.provider).trigger("accountAddModal.buttons.add.action.before",[this]),!_.isEmpty(o.provider)&&void 0!==o.submitHandlers[o.provider])return o.submitHandlers[o.provider](this)}},cancel:{text:wpforms_builder.cancel}}})},registerAddHandler:function(e,n){"string"==typeof e&&"function"==typeof n&&(this.submitHandlers[e]=n)},isConfigured:function(e){return p.getProviderHolder(e).find(".js-wpforms-builder-provider-account-add").hasClass("hidden")}}},getProviderHolder:function(e){return l("#"+e+"-provider")}};return p}(document,(window,jQuery)),WPForms.Admin.Builder.Providers.init();